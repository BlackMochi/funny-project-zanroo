<html>
    <body>
        <script>
            const message = {
                desc: 'xxx bnk48 xxxx ornbnk48 bnk',
                raw_desc: '<img src="yyy" title="bnk48"/> xxx bnk48 xxxx   <br /> ornbnk48 bnk',
                keywords: [{
                    hls: [4, 9, 18, 23]
                }, {
                    hls: [15, 23]
                }]
            }
            const message2 = {
                desc: "สวัสดีครับ ผมตาม bnk48 มาตั้งแต่ปีที่แล้ว โดยที่ไม่รู้จัก akb48 หรือวงน้องอื่นๆมาก่อน แต่ช่วงหลังๆนี้เริ่มสนใจ เพราะได้ดูรายการ produce48 และเลือกตั้ง world senbatsu รู้สึกชอบสองคนนี้มากๆ จูรินะ กับ ซากุระ และเห็นมีคนพูดถึงกันเยอะมากๆในรายการ ตอนนี้กำลังดูซีรี่ย์ที่มีสองคนแสดงนำ Tofu Pro Wrestling อยากสอบถามว่าสองคนนี้มีอะไรที่แสดงด้วยกันอีกไหมครับ เช่น รายการแนว bnk48show เพลงหรือซีรี่ย์เรื่องอื่นๆ ใครมีรบกวนแปะลิงค์ที่เป็นซับไทยหรืออิ้งไว้จะขอบคุณมากครับ อาจจะแปลกๆนะแต่ด้วยความที่ผมเป็นชิปเปอร์ เฌอสิค เลยรู้สึกจิ้นคู่นี้เหมือนกัน เพราะมีคนจับโมเม้นต์ของทั้งคู่ให้เห็นผ่านๆบ้างในแท็ก produce48 แล้วสองคนนี้ที่เขาบอกเป็นคู่แข่งกันนี่ยังไงเหรอครับ ใครพอเล่ารายละเอียดได้บ้าง ผมก็ไม่รู้จะเริ่มตามจากจุดไหน แนะนำด้วยนะครับ รบกวนด้วยครับ",
                raw_desc: "<span style=\"font-size: 150%; line-height: 116%;\">Sale or Rent the 3 Storey\nDetached House in the project of AQ Arbor, Décor as the sample\nhouse<br>\nThe price of renting is only 50,000 Baht per month<br>\nSale for only 9.99 million Baht (the owner moving\nabroad)</span><br>\n<br>\n- in case of renting, pay 1 month prior and 3 months deposit with 1\nyear of contract<br>\n- Contact the owner directly (Khun J 089 666 3660)<br>\n<br>\nFor the Agent, open-ended contract only<br>\n<br>\n- Chalermprakiat Rama 9 Road Soi 48, Near Suanluang Rama9<br>\n- The area of 55 Sq. Wah, Utility Space 280 Sq.m.<br>\n- 3 Bedrooms 4 Bathrooms 2 Parking Lots, which is very nice to live\nin<br>\n- With Furniture (in case of renting and need more furniture, this\ncan be negotiated)<br>\n<div class=\"inline-attachment\">\n<dl class=\"file\">\n<dt class=\"attach-image\"><img src=\"./download/file.php?id=110194&sid=257603db1d7350b8eb7ec6ebf20e0432\" class=\"postimage\" alt=\"&#xE02;&#xE32;&#xE22;&#xE1A;&#xE49;&#xE32;&#xE19;&#xE40;&#xE14;&#xE35;&#xE48;&#xE22;&#xE27; AQ Arbor1.jpg\" onclick=\"viewableArea(this);\"></dt>\n<dd>ขายบ้านเดี่ยว AQ Arbor1.jpg (34.56 KiB) เปิดดู 65550 ครั้ง</dd>\n</dl>\n</div>\n<br>\n<div class=\"inline-attachment\">\n<dl class=\"file\">\n<dt class=\"attach-image\"><img src=\"./download/file.php?id=110193&sid=257603db1d7350b8eb7ec6ebf20e0432\" class=\"postimage\" alt=\"&#xE02;&#xE32;&#xE22;&#xE1A;&#xE49;&#xE32;&#xE19;&#xE40;&#xE14;&#xE35;&#xE48;&#xE22;&#xE27; AQ Arbor3.jpg\" onclick=\"viewableArea(this);\"></dt>\n<dd>ขายบ้านเดี่ยว AQ Arbor3.jpg (53.26 KiB) เปิดดู 65550 ครั้ง</dd>\n</dl>\n</div>\n<br>\n<div class=\"inline-attachment\">\n<dl class=\"file\">\n<dt class=\"attach-image\"><img src=\"./download/file.php?id=110192&sid=257603db1d7350b8eb7ec6ebf20e0432\" class=\"postimage\" alt=\"&#xE02;&#xE32;&#xE22;&#xE1A;&#xE49;&#xE32;&#xE19;&#xE40;&#xE14;&#xE35;&#xE48;&#xE22;&#xE27; AQ Arbor2.jpg\" onclick=\"viewableArea(this);\"></dt>\n<dd>ขายบ้านเดี่ยว AQ Arbor2.jpg (69.28 KiB) เปิดดู 65550 ครั้ง</dd>\n</dl>\n</div>\n<br>\n<br>\n<span style=\"font-size: 150%; line-height: 116%;\">Facilities</span><br>\n<br>\n- 1 Outdoor Swimming Pool with Salt System, size of 6 x 34 meters,\n1.5 meters depth with 0.45 meters depth child pool together with\nlocker rooms and separated toilets<br>\n- 1 fitness room, size of 80 Sq.m. with equipments<br>\n- Recreation Room, size of 40 Sq.m.<br>\n- 10 parks, size of 1-2-75 Rai<br>\n- Fences around the project with 3 meters height<br>\n- CCTV Systems at the main gate and 20 points in the project<br>\n- Free Wi-Fi at Club house<br>\n- Key Card Access in the near field<br>\n- Security guard available for 24 hours<br>\n- The project’s fences using the Double Gate System with both\nsecurity barrier and electric door<br>\n- Burglar alarm using Magnetic & Shock Sensor System installed\nin every house<br>\n- 12 meter width of main road and 8 meters width of road in the\nproject<br>\n<br>\nTag: Detached House for sale, house for rent, renting house, AQ\nArbor House, cheap house for rent, house for rent in Pravet, house\nin Pravet, AQ Arbor, cheap house for sale, Suanluang Rama 9,\nPattanakarn, houses, Detached House, one year contract house, house\nwith furniture, looking for cheap house, furniture, looking for\ncheap detached house, Burglar alarm, CCTV, Swimming Pool, Club\nhouse",
                "keywords": [
      {
        "id": "59f229183aece933ec4fb226",
        "hls": [
          1053,
          1063
        ],
        "tags": [],
        "sentiment": -1
      },
      {
        "id": "59f229183aece933ec4fb304",
        "hls": [],
        "tags": [],
        "sentiment": -1
      },
      {
        "id": "59f229183aece933ec4fb587",
        "hls": [],
        "tags": [],
        "sentiment": -1
      },
      {
        "id": "59f229183aece933ec4fb4e4",
        "hls": [],
        "tags": [],
        "sentiment": -1
      }
    
            ]
            }
            const hilightText = (desc, keywords) => {
                let i, j, k, max, tmp, max_index, count = 0, state_count, state_insert, before_char, queue = []
                //create array of queue
                for (i = 0; i < keywords.length; i++) {
                    if(keywords[i].hls)
                        queue.push({"size_of_char": keywords[i].hls[1] - keywords[i].hls[0],"idx": i})           
                }
                //sort array min to max 
                queue.sort(function(a, b){return a.size_of_char - b.size_of_char});
                //insert <em></em>
                //console.log(keywords.length-1)
                for(i = queue.length-1; i >= 0; i--) {
                    //console.log(keywords[queue[i].idx].hls.length)
                    for(j = 0; j < keywords[queue[i].idx].hls.length; j+=2) {
                        count = 0
                        state_count = -1
                        state_insert = 1
                        for(k = 0; k < desc.length; k++) {
                            if(desc[k] == '<' && desc[k + 1] && desc[k + 1] != ' ') {
                                if(desc[k] == '<' && desc[k + 1] == 'e' && desc[k + 2] == 'm' && desc[k + 3] == '>') {
                                    k += 3
                                    state_insert = 0
                                } else if(desc[k] == '<' && desc[k + 1] == '/' && desc[k + 2] == 'e' && desc[k + 3] == 'm' && desc[k + 4] == '>') {
                                    k += 4
                                    state_insert = 1
                                } else {
                                    while(desc[k] != '>') {
                                        k++
                                    }
                                }
                            }
                            else if(desc[k] == '\\' && desc[k + 1] && desc[k + 1] == 'n') {
                                k += 1
                            }
                            else if(desc[k] == '&' && desc[k + 1] && desc[k + 1] != ' ') {
                                while(desc[k] != ';') {
                                        k++
                                    }
                            }  
                            else {
                                if(state_count == -1) {
                                    if(desc[k] != ' ') {
                                        state_count = 1
                                    }             
                                }
                                if(state_count == 1) {
                                    if(state_insert == 1) {
                                        if(count == keywords[queue[i].idx].hls[j]) {
                                            //console.log("count == keywords[queue[i].idx].hls[j]")
                                            if(desc[k] != '<' && desc[k + 1] != 'e') {
                                                //console.log("desc[k] != '<' && desc[k + 1] != 'e'")
                                                if(before_char == ' ' && desc[k] == ' ') {
                                                    //console.log("Don't insert")
                                                } else {
                                                    desc = desc.substring(0, k) + '<em>' + desc.substring(k, desc.length);
                                                    desc = desc.substring(0, k + queue[i].size_of_char + 4) + '</em>' + desc.substring(k + queue[i].size_of_char + 4, desc.length);
                                                }
                                            }                                                                                     
                                        }
                                    }                   
                                    //console.log('desc[k] = '+desc[k]+', count = '+count)                                
                                    if(before_char == ' ' && desc[k] == ' ') {
                                    } else {
                                        before_char = desc[k]
                                        count++
                                        //console.log('count -> ' + count)
                                    }                                                      
                                }
                            }
                                
                        }
                    }
                }
                //console.log(desc)          
                return desc
            }
            console.log(message2.desc)
            console.log(hilightText(message2.raw_desc, message2.keywords))
            if(message2.desc == hilightText(message2.raw_desc, message2.keywords)) {
                console.log('Good job')
            }
        </script>
    </body>
</html>